import{g as Kt,f as Vt,q as X,bj as Xt,r as g,j as s,t as w,M as T,bO as Jt,bP as Zt,bI as J,a as Qt,i as Nt,ab as Z,z as Q,B as Ut,ac as $t,bQ as te,bR as ee,au as se,av as ae,aw as ne,bl as qt,bu as oe,aC as ie,bS as re,m as Ft,F as Mt,a5 as _t,aG as le,bx as ce,n as R,by as de,bz as ue,bB as me,a_ as U,bD as ge,bE as pe,bF as be,W as he,bT as y,bU as xe,bV as fe,b2 as zt,bd as Et,bH as Ce,bW as Ie,aI as Se,s as V,aU as $,bX as je,I as De,ad as Re,bY as ve,bZ as kt,bJ as Le,bK as Ae,bL as Be,T as G,b_ as Te,bN as we,S as Fe,A as Me,bn as ke,L as Y}from"./index-qz_z9GmZ.js";import{L as Pe,F as Ne,S as Ue}from"./library-background-overlay-CdEXqwMP.js";import{u as Pt,M as $e}from"./album-list-query-DRHfuUWa.js";import{u as qe}from"./use-current-song-row-styles-AW__6X7H.js";const _e=u=>{const{api:i,discNumber:r,subtitle:o}=u,e=[];return i.forEachNode(t=>{t.data.discNumber===r&&t.data.discSubtitle===o&&e.push(t)}),e},ze=u=>{const{isSelected:i,nodes:r}=u;r.forEach(o=>{o.setSelected(i)})},tt=u=>{const{options:i,query:r,serverId:o}=u,e=Kt(o);return Vt({queryFn:({signal:t})=>{if(!e)throw new Error("Server not found");return Xt.getAlbumDetail({apiClientProps:{server:e,signal:t},query:r})},queryKey:X.albums.detail((e==null?void 0:e.id)||"",r),...i})},Ee=J(Qt)`
    display: flex;
    height: 100%;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
`,He=({api:u,data:i,node:r})=>{const[o,e]=g.useState(!1),t=()=>{if(!i)return;const m=r.data.id.split("-"),d=Number(m[1]),c=m.length===3?m.slice(2).join("-"):null,I=_e({api:u,discNumber:d,subtitle:c});ze({isSelected:!o,nodes:I}),e(x=>!x)};return s.jsx(Ee,{children:s.jsx(w,{position:"apart",w:"100%",children:s.jsx(T,{compact:!0,leftIcon:o?s.jsx(Jt,{}):s.jsx(Zt,{}),onClick:t,size:"md",variant:"subtle",children:i.name})})})},K=u=>{var i;return(i=u.id)==null?void 0:i.startsWith("disc-")},Oe=J.div`
    position: relative;
    z-index: 0;
`,We=J.div`
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding: 1rem 2rem 5rem;
    overflow: hidden;
`,Ge=({background:u,tableRef:i})=>{var ot,it,rt,lt,ct,dt,ut,mt,gt,pt,bt,ht,xt,ft,Ct,It,St,jt,Dt,Rt,vt,Lt,At,Bt,Tt;const{t:r}=Nt(),{albumId:o}=Z(),e=Q(),t=tt({query:{id:o},serverId:e==null?void 0:e.id}),m=Ut(),d=$t(),c=te("albumDetail"),{setTable:I}=ee(),x=se(),k=ae(),F=ne(),{externalLinks:M,lastFM:v,musicBrainz:S}=qt(),L=oe(),A=g.useMemo(()=>ie(c.columns,!1,"albumDetail"),[c.columns]),q=g.useCallback(a=>K(a.node)?45:c.rowHeight,[c.rowHeight]),_=g.useMemo(()=>{var N;if(!((N=t.data)!=null&&N.songs))return[];let a=-1,n=null;const C=[],O=r("common.disc",{postProcess:"upperCase"});for(const D of t.data.songs){if(D.discNumber!==a||D.discSubtitle!==n){a=D.discNumber,n=D.discSubtitle;let W=`disc-${a}`,wt=`${O} ${a}`;n&&(W+=`-${n}`,wt+=`: ${n}`),C.push({id:W,name:wt})}C.push(D)}return C},[(ot=t.data)==null?void 0:ot.songs,r]),[j,B]=re({artist:0}),z=g.useCallback(a=>{B({[a]:j[a]+1})},[j,B]),E=g.useCallback(a=>{B({[a]:j[a]-1})},[j,B]),p=Pt({options:{cacheTime:1e3*60,enabled:((rt=(it=t==null?void 0:t.data)==null?void 0:it.albumArtists[0])==null?void 0:rt.id)!==void 0,keepPreviousData:!0,staleTime:1e3*60},query:{_custom:{jellyfin:{ExcludeItemIds:(lt=t==null?void 0:t.data)==null?void 0:lt.id}},artistIds:(ct=t==null?void 0:t.data)!=null&&ct.albumArtists.length?[(dt=t==null?void 0:t.data)==null?void 0:dt.albumArtists[0].id]:void 0,limit:15,sortBy:Mt.YEAR,sortOrder:Ft.DESC,startIndex:0},serverId:e==null?void 0:e.id}),P={genres:(ut=t.data)!=null&&ut.genres.length?[t.data.genres[0].id]:void 0,limit:15,sortBy:Mt.RANDOM,sortOrder:Ft.ASC,startIndex:0},b=Pt({options:{cacheTime:1e3*60,enabled:!!((gt=(mt=t==null?void 0:t.data)==null?void 0:mt.genres)!=null&&gt[0]),queryKey:X.albums.related((e==null?void 0:e.id)||"",o,P),staleTime:1e3*60},query:P,serverId:e==null?void 0:e.id}),H=[{data:(pt=p==null?void 0:p.data)==null?void 0:pt.items.filter(a=>{var n;return a.id!==((n=t==null?void 0:t.data)==null?void 0:n.id)}),isHidden:!((bt=p==null?void 0:p.data)!=null&&bt.items.filter(a=>{var n;return a.id!==((n=t==null?void 0:t.data)==null?void 0:n.id)}).length),loading:(p==null?void 0:p.isLoading)||p.isFetching,pagination:{handleNextPage:()=>z("artist"),handlePreviousPage:()=>E("artist"),hasPreviousPage:j.artist>0},title:r("page.albumDetail.moreFromArtist",{postProcess:"sentenceCase"}),uniqueId:"mostPlayed"},{data:(ht=b==null?void 0:b.data)==null?void 0:ht.items.filter(a=>{var n;return a.id!==((n=t==null?void 0:t.data)==null?void 0:n.id)}),isHidden:!((xt=b==null?void 0:b.data)!=null&&xt.items.filter(a=>{var n;return a.id!==((n=t==null?void 0:t.data)==null?void 0:n.id)}).length),loading:(b==null?void 0:b.isLoading)||b.isFetching,title:r("page.albumDetail.moreFromGeneric",{item:(It=(Ct=(ft=t==null?void 0:t.data)==null?void 0:ft.genres)==null?void 0:Ct[0])==null?void 0:It.name,postProcess:"sentenceCase"}),uniqueId:"relatedGenres"}],l=_t(),h=async a=>{var n;d==null||d({byData:(n=t==null?void 0:t.data)==null?void 0:n.songs,playType:a||l})},f=le(R.SONG,ce),Ht=a=>{if(!a.data||a.node.isFullWidthCell())return;const n=[];a.api.forEachNode(C=>{!C.data||C.isFullWidthCell()||n.push(C.data)}),d==null||d({byData:n,initialSongId:a.data.id,playType:l})},et=de({}),st=ue({}),Ot=()=>{t!=null&&t.data&&(t.data.userFavorite?st.mutate({query:{id:[t.data.id],type:R.ALBUM},serverId:t.data.serverId}):et.mutate({query:{id:[t.data.id],type:R.ALBUM},serverId:t.data.serverId}))},Wt=(St=t==null?void 0:t.data)!=null&&St.genres?((jt=t==null?void 0:t.data)==null?void 0:jt.genres.length)!==0:!1,at=(Dt=t==null?void 0:t.data)==null?void 0:Dt.comment,Gt=me(R.ALBUM,je),yt=g.useCallback(()=>{const{columnApi:a}=(i==null?void 0:i.current)||{},n=a==null?void 0:a.getAllGridColumns();if(!n)return;const C=c.columns,O=[];for(const N of n){const D=C.find(W=>W.column===N.getColDef().colId);D&&O.push({...D,...!c.autoFit&&{width:N.getActualWidth()}})}I("albumDetail",{...c,columns:O})},[I,c,i]),{rowClassRules:Yt}=qe({tableRef:i}),nt=(Rt=t==null?void 0:t.data)==null?void 0:Rt.mbzId;return s.jsxs(Oe,{children:[s.jsx(Pe,{$backgroundColor:u}),s.jsxs(We,{children:[s.jsx(U,{component:"section",children:s.jsxs(w,{position:"apart",spacing:"sm",children:[s.jsxs(w,{children:[s.jsx(ge,{onClick:()=>h(l)}),s.jsx(T,{compact:!0,loading:et.isLoading||st.isLoading,onClick:Ot,variant:"subtle",children:(vt=t==null?void 0:t.data)!=null&&vt.userFavorite?s.jsx(pe,{color:"red",size:20}):s.jsx(be,{size:20})}),s.jsx(T,{compact:!0,onClick:a=>{t!=null&&t.data&&Gt(a,[t.data])},variant:"subtle",children:s.jsx(he,{size:20})})]}),s.jsxs(y,{position:"bottom-end",children:[s.jsx(y.Target,{children:s.jsx(T,{compact:!0,size:"md",variant:"subtle",children:s.jsx(xe,{size:20})})}),s.jsx(y.Dropdown,{children:s.jsx(fe,{type:"albumDetail"})})]})]})}),Wt&&s.jsx(U,{component:"section",children:s.jsx(w,{spacing:"sm",children:(At=(Lt=t==null?void 0:t.data)==null?void 0:Lt.genres)==null?void 0:At.map(a=>s.jsx(T,{compact:!0,component:Et,radius:0,size:"md",to:zt(L,{genreId:a.id}),variant:"outline",children:a.name},`genre-${a.id}`))})}),M&&(v||S)?s.jsx(U,{component:"section",children:s.jsxs(w,{spacing:"sm",children:[v&&s.jsx(T,{compact:!0,component:"a",href:`https://www.last.fm/music/${encodeURIComponent(((Bt=t==null?void 0:t.data)==null?void 0:Bt.albumArtist)||"")}/${encodeURIComponent(((Tt=t.data)==null?void 0:Tt.name)||"")}`,radius:"md",rel:"noopener noreferrer",size:"md",target:"_blank",tooltip:{label:r("action.openIn.lastfm")},variant:"subtle",children:s.jsx(Ne,{size:25})}),S&&nt?s.jsx(T,{compact:!0,component:"a",href:`https://musicbrainz.org/release/${nt}`,radius:"md",rel:"noopener noreferrer",size:"md",target:"_blank",tooltip:{label:r("action.openIn.musicbrainz")},variant:"subtle",children:s.jsx(Ue,{size:25})}):null]})}):null,at&&s.jsx(U,{component:"section",children:s.jsx(Ce,{maxHeight:75,children:Ie(at)})}),s.jsx(U,{style:{minHeight:"300px"},children:s.jsx(Se,{autoFitColumns:c.autoFit,autoHeight:!0,columnDefs:A,context:{currentSong:F,isFocused:k,itemType:R.SONG,onCellContextMenu:f,status:x},enableCellChangeFlash:!1,fullWidthCellRenderer:He,getRowHeight:q,getRowId:a=>a.data.id,isFullWidthRow:a=>K(a.rowNode)||!1,isRowSelectable:a=>!K(a.data),onCellContextMenu:f,onColumnMoved:yt,onRowDoubleClicked:Ht,ref:i,rowClassRules:Yt,rowData:_,rowSelection:"multiple",shouldUpdateSong:!0,stickyHeader:!0,suppressCellFocus:!0,suppressLoadingOverlay:!0,suppressRowDrag:!0},`table-${c.rowHeight}`)}),s.jsx(V,{mt:"3rem",ref:m.ref,spacing:"lg",children:m.height||m.width?s.jsx(s.Fragment,{children:H.filter(a=>!a.isHidden).map((a,n)=>s.jsx($e,{cardRows:[{property:"name",route:{route:$.LIBRARY_ALBUMS_DETAIL,slugs:[{idProperty:"id",slugProperty:"albumId"}]}},{arrayProperty:"name",property:"albumArtists",route:{route:$.LIBRARY_ALBUM_ARTISTS_DETAIL,slugs:[{idProperty:"id",slugProperty:"albumArtistId"}]}}],data:a.data,isLoading:a.loading,itemType:R.ALBUM,route:{route:$.LIBRARY_ALBUMS_DETAIL,slugs:[{idProperty:"id",slugProperty:"albumId"}]},title:{label:a.title},uniqueId:a.uniqueId},`carousel-${a.uniqueId}-${n}`))}):null})]})]})},ye=g.forwardRef(({background:u},i)=>{var S,L,A,q,_,j,B,z,E,p,P,b,H;const{albumId:r}=Z(),o=Q(),e=tt({query:{id:r},serverId:o==null?void 0:o.id}),t=Ut(),{t:m}=Nt(),d=((S=e==null?void 0:e.data)==null?void 0:S.serverType)===De.NAVIDROME,c=((L=e.data)==null?void 0:L.originalDate)&&e.data.originalDate!==e.data.releaseDate,I=c?m("page.albumDetail.released",{postProcess:"sentenceCase"}):"♫",x=g.useMemo(()=>{var l,h;return new Set((h=(l=e.data)==null?void 0:l.songs)==null?void 0:h.map(f=>f.id))},[(A=e.data)==null?void 0:A.songs]),k=g.useCallback(l=>{if(x.has(l)){const h=X.albums.detail(o==null?void 0:o.id,{id:r});Re.setQueryData(h,f=>{if(f)return{...f,playCount:f.playCount?f.playCount+1:1}})}},[r,o==null?void 0:o.id,x]);ve((l,h)=>{h.event==="play"&&k(l[0])},e.data!==void 0);const F=[{id:"releaseDate",value:((q=e==null?void 0:e.data)==null?void 0:q.releaseDate)&&`${I} ${kt((_=e==null?void 0:e.data)==null?void 0:_.releaseDate)}`},{id:"songCount",value:`${(j=e==null?void 0:e.data)==null?void 0:j.songCount} ${m("entity.track_other",{count:(B=e==null?void 0:e.data)==null?void 0:B.songCount})}`},{id:"duration",value:((z=e==null?void 0:e.data)==null?void 0:z.duration)&&Le(e.data.duration)},{id:"playCount",value:m("entity.play",{count:(E=e==null?void 0:e.data)==null?void 0:E.playCount})}];if(c){const l=`♫ ${kt(e.data.originalDate)}`;F.splice(0,0,{id:"originalDate",value:l})}const M=Ae({}),v=l=>{e!=null&&e.data&&M.mutate({query:{item:[e.data],rating:l},serverId:e.data.serverId})};return s.jsx(V,{ref:t.ref,children:s.jsx(Be,{imageUrl:(p=e==null?void 0:e.data)==null?void 0:p.imageUrl,item:{route:$.LIBRARY_ALBUMS,type:R.ALBUM},ref:i,title:((P=e==null?void 0:e.data)==null?void 0:P.name)||"",...u,children:s.jsxs(V,{spacing:"sm",children:[s.jsxs(w,{spacing:"sm",children:[F.map((l,h)=>s.jsxs(g.Fragment,{children:[h>0&&s.jsx(G,{$noSelect:!0,children:"•"}),s.jsx(G,{children:l.value})]},`item-${l.id}-${h}`)),d&&s.jsxs(s.Fragment,{children:[s.jsx(G,{$noSelect:!0,children:"•"}),s.jsx(Te,{onChange:v,readOnly:(e==null?void 0:e.isFetching)||M.isLoading,value:((b=e==null?void 0:e.data)==null?void 0:b.userRating)||0})]})]}),s.jsx(w,{mah:"4rem",spacing:"md",sx:{overflow:"hidden",WebkitBoxOrient:"vertical",WebkitLineClamp:2},children:(H=e==null?void 0:e.data)==null?void 0:H.albumArtists.map(l=>s.jsx(G,{$link:!0,component:Et,fw:600,to:zt($.LIBRARY_ALBUM_ARTISTS_DETAIL,{albumArtistId:l.id}),variant:"subtle",children:l.name},`artist-${l.id}`))})]})})})}),Je=()=>{var S,L,A;const u=g.useRef(null),i=g.useRef(null),r=g.useRef(null),{albumBackground:o,albumBackgroundBlur:e}=qt(),{albumId:t}=Z(),m=Q(),d=tt({query:{id:t},serverId:m==null?void 0:m.id}),{color:c,colorId:I}=we({id:t,src:(S=d.data)==null?void 0:S.imageUrl,srcLoaded:!d.isLoading}),x=$t(),k=_t(),F=()=>{x==null||x({byItemType:{id:[t],type:R.ALBUM},playType:k})};if(!c||I!==t)return s.jsx(Fe,{container:!0});const M=((L=d.data)==null?void 0:L.imageUrl)||"",v=o&&`url(${M})`||c;return s.jsx(Me,{children:s.jsxs(ke,{pageHeaderProps:{backgroundColor:c||void 0,children:s.jsxs(Y,{children:[s.jsx(Y.PlayButton,{onClick:F}),s.jsx(Y.Title,{children:(A=d==null?void 0:d.data)==null?void 0:A.name})]}),offset:200,target:r},ref:i,children:[s.jsx(ye,{background:{background:v,blur:o&&e||0},ref:r}),s.jsx(Ge,{background:v,tableRef:u})]})},`album-detail-${t}`)};export{Je as default};
//# sourceMappingURL=album-detail-route-Ojl_lBgA.js.map
